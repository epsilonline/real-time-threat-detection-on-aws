#! /bin/bash

# Configure AWS Profile
AWS_PROFILE="default"

# Nome della sessione tmux
SESSION_NAME="malware_demo"

# Array di ID delle istanze EC2
BUCKET_AV_SQS="bucket-av-stack-ScanQueue-TLAWztYk971C"
GUARDUTY_ANTIMALWARE_SQS="workshop-rttdoa-scanning-events"

# Controlla se la sessione esiste già
if tmux has-session -t $SESSION_NAME 2>/dev/null; then
    echo "La sessione tmux '$SESSION_NAME' esiste già."
    exit 1
fi

# Crea una nuova sessione tmux in background
tmux new-session -d -s $SESSION_NAME

# Dividi la finestra in 4 pannelli
tmux split-window -h   # Divide in due colonne

for i in {0..1}; do
    tmux select-pane -t $i
    tmux send-keys "export AWS_PROFILE=${AWS_PROFILE}" C-m
    tmux send-keys "cd ../terraform/.terraform/modules/guardduty_antimalware/code" C-m

done

# Monitor dmesg logs
tmux select-pane -t 0
tmux send-keys "python3 consume_sqs.py ${BUCKET_AV_SQS}" C-m

# Monitor ingress packets
tmux select-pane -t 1
tmux send-keys "python3 consume_sqs.py ${GUARDUTY_ANTIMALWARE_SQS}" C-m

# Attacca alla sessione
tmux select-pane -t 0  # Seleziona il primo pannello
tmux attach-session -t $SESSION_NAME
